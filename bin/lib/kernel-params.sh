#!/bin/bash

# Kernel Parameters Library - VPS optimization for Node.js + Nginx + PM2
# Supports both apply and rollback of kernel parameters via sysctl

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/sudo-helper.sh"

BACKUP_DIR="/home/pilote/projet/primaire/BUILDER/bin/lib/kernel-backups"
SYSCTL_BACKUP="$BACKUP_DIR/sysctl-backup-$(date +%Y%m%d-%H%M%S).conf"
SYSCTL_CUSTOM="/etc/sysctl.d/99-vps-optimize.conf"

# Initialize backup directory
init_backup_dir() {
  mkdir -p "$BACKUP_DIR"
}

# Get recommended kernel parameters for Node.js + Nginx + PM2 workload
get_recommended_params() {
  cat <<'EOF'
# Network Optimizations
net.core.somaxconn=65535
net.ipv4.tcp_max_syn_backlog=65535
net.ipv4.ip_local_port_range=1024 65535
net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_fin_timeout=30

# Connection Pool
net.ipv4.tcp_max_tw_buckets=2000000
net.ipv4.tcp_keepalive_time=600
net.ipv4.tcp_keepalive_probes=3
net.ipv4.tcp_keepalive_intvl=15

# Performance Tuning
net.core.netdev_max_backlog=65535
net.ipv4.tcp_rmem=4096 87380 67108864
net.ipv4.tcp_wmem=4096 65536 67108864

# File Descriptor Limits
fs.file-max=2097152
fs.nr_open=2097152

# Memory Management
vm.swappiness=10
vm.vfs_cache_pressure=50
EOF
}

# Read current sysctl values into associative array
# Usage: read_current_params "param1" "param2" ...
read_current_params() {
  local param
  while [[ $# -gt 0 ]]; do
    param="$1"
    sudo_exec sysctl -n "$param" 2>/dev/null || echo "NOTFOUND"
    shift
  done
}

# Get all current sysctl values and save to file
backup_current_sysctl() {
  echo "Backing up current sysctl configuration..."
  init_backup_dir

  sudo_exec sysctl -a > "$SYSCTL_BACKUP"

  echo "Backup saved to: $SYSCTL_BACKUP"
}

# Apply kernel parameters from string or file
# Usage: apply_params "param.name=value\nparam.name2=value2"
apply_params() {
  local params="$1"
  local verify_only="${2:-false}"

  echo "Applying kernel parameters..."

  # Create temporary sysctl file
  local tmp_file="/tmp/kernel-params-$$.conf"
  echo "$params" > "$tmp_file"

  # Apply via sysctl
  if [ "$verify_only" == "true" ]; then
    echo "[DRY RUN] Would apply:"
    cat "$tmp_file"
    rm "$tmp_file"
    return 0
  fi

  # Apply to running system
  while IFS='=' read -r param value; do
    # Skip empty lines and comments
    [[ -z "$param" || "$param" =~ ^# ]] && continue

    param=$(echo "$param" | xargs)  # trim whitespace
    value=$(echo "$value" | xargs)

    echo "  Setting: $param = $value"
    sudo_exec sysctl -w "$param=$value" > /dev/null || {
      echo "WARNING: Failed to set $param (may require reboot)"
    }
  done <<< "$params"

  rm "$tmp_file"
  echo "Kernel parameters applied to running system"
}

# Write parameters to permanent sysctl file
# Usage: write_permanent_params "param.name=value\nparam.name2=value2"
write_permanent_params() {
  local params="$1"

  echo "Writing parameters to $SYSCTL_CUSTOM (permanent)..."

  # Create file with header comment
  local tmp_file="/tmp/sysctl-custom-$$.conf"
  cat > "$tmp_file" <<'HEADER'
# VPS Performance Optimization - Node.js + Nginx + PM2
# Generated by tune-kernel CLI
# Last updated: DATE_PLACEHOLDER

HEADER

  # Replace date placeholder
  sed -i "s/DATE_PLACEHOLDER/$(date)/" "$tmp_file"

  # Add parameters
  echo "$params" >> "$tmp_file"

  # Write to permanent location with sudo
  if [ -f "$tmp_file" ]; then
    sudo_exec cp "$tmp_file" "$SYSCTL_CUSTOM"
    rm "$tmp_file"
    echo "Parameters written to $SYSCTL_CUSTOM"
  fi
}

# Verify parameters are applied correctly
# Usage: verify_params "param.name=expected_value" "param.name2=expected_value2"
verify_params() {
  local all_match=true

  echo "Verifying kernel parameters..."

  while [[ $# -gt 0 ]]; do
    local expected="$1"
    local param=$(echo "$expected" | cut -d'=' -f1)
    local expected_val=$(echo "$expected" | cut -d'=' -f2)

    # Get actual value
    local actual_val=$(sudo_exec sysctl -n "$param" 2>/dev/null || echo "NOTFOUND")

    if [ "$actual_val" == "$expected_val" ]; then
      echo "  ✓ $param = $actual_val"
    else
      echo "  ✗ $param: expected=$expected_val, actual=$actual_val"
      all_match=false
    fi

    shift
  done

  if [ "$all_match" == "true" ]; then
    return 0
  else
    return 1
  fi
}

# Get all kernel parameters currently in 99-vps-optimize.conf
get_applied_params() {
  if [ ! -f "$SYSCTL_CUSTOM" ]; then
    echo ""
    return 1
  fi

  # Filter out comments and empty lines
  grep -v "^#" "$SYSCTL_CUSTOM" | grep -v "^$" || echo ""
}

# Show current vs default comparison for key parameters
show_comparison() {
  local params=(
    "net.core.somaxconn"
    "net.ipv4.tcp_max_syn_backlog"
    "net.ipv4.ip_local_port_range"
    "fs.file-max"
    "fs.nr_open"
    "net.ipv4.tcp_tw_reuse"
    "vm.swappiness"
  )

  echo "Current Kernel Parameter Values:"
  echo "================================="

  for param in "${params[@]}"; do
    local current=$(sudo_exec sysctl -n "$param" 2>/dev/null || echo "N/A")
    printf "%-40s = %s\n" "$param" "$current"
  done
}

# Rollback to backup (requires specific backup file)
# Usage: rollback_params "/path/to/backup.conf"
rollback_params() {
  local backup_file="$1"

  if [ -z "$backup_file" ] || [ ! -f "$backup_file" ]; then
    echo "ERROR: Backup file not found: $backup_file"
    return 1
  fi

  echo "Rolling back kernel parameters from: $backup_file"

  # This is a safety feature - we only rollback specific parameters, not all
  # Reading the backup file and extracting critical parameters
  # Note: Full rollback requires sysctl restore which is kernel-specific

  echo "WARNING: Full rollback requires system reboot for some parameters"
  echo "To rollback, restore your backup: sudo sysctl -p $backup_file"

  return 0
}

# Get backup file list
list_backups() {
  if [ ! -d "$BACKUP_DIR" ]; then
    echo "No backups found"
    return 0
  fi

  echo "Available kernel backups:"
  ls -lh "$BACKUP_DIR"/sysctl-backup-*.conf 2>/dev/null | awk '{print $9, "(" $5 ")"}'
}

# Export functions for use in other scripts
export -f init_backup_dir
export -f get_recommended_params
export -f read_current_params
export -f backup_current_sysctl
export -f apply_params
export -f write_permanent_params
export -f verify_params
export -f get_applied_params
export -f show_comparison
export -f rollback_params
export -f list_backups
