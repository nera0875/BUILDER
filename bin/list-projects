#!/bin/bash

# BUILDER - List All Projects
# Usage: list-projects

# Cleanup deleted projects from port registry
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
"$SCRIPT_DIR/port-manager" cleanup 2>/dev/null

echo "ðŸ“‹ BUILDER Projects"
echo ""

SECONDAIRE_DIR="/home/pilote/projet/secondaire"

if [ ! -d "$SECONDAIRE_DIR" ]; then
  echo "âŒ No projects directory found"
  exit 1
fi

# Get all projects
PROJECTS=$(ls -1 "$SECONDAIRE_DIR" 2>/dev/null)

if [ -z "$PROJECTS" ]; then
  echo "   (No projects yet)"
  echo ""
  echo "ðŸš€ Create your first project:"
  echo "   new-project my-app"
  exit 0
fi

# Get PM2 processes (use node to parse JSON)
PM2_JSON_FILE=$(mktemp)
pm2 jlist 2>/dev/null > "$PM2_JSON_FILE" || echo "[]" > "$PM2_JSON_FILE"

echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ Project            â”‚ Status   â”‚ Preview URL                        â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"

for PROJECT in $PROJECTS; do
  PROJECT_DIR="$SECONDAIRE_DIR/$PROJECT"

  # Skip if not a directory
  if [ ! -d "$PROJECT_DIR" ]; then
    continue
  fi

  # Check if deployed
  if [ -f "$PROJECT_DIR/.env" ] && grep -q "^PORT=" "$PROJECT_DIR/.env"; then
    PORT=$(grep "^PORT=" "$PROJECT_DIR/.env" | cut -d'=' -f2)

    # Check PM2 status using node
    PM2_STATUS=$(node -e "
      const fs = require('fs');
      try {
        const data = JSON.parse(fs.readFileSync('$PM2_JSON_FILE', 'utf8'));
        const proc = data.find(p => p.name === '$PROJECT');
        console.log(proc ? proc.pm2_env.status : '');
      } catch(e) { console.log(''); }
    ")

    if [ "$PM2_STATUS" == "online" ]; then
      STATUS="ðŸŸ¢ online"
      URL="http://89.116.27.88:$PORT"
    elif [ "$PM2_STATUS" == "stopped" ]; then
      STATUS="ðŸŸ¡ stopped"
      URL="http://89.116.27.88:$PORT (stopped)"
    else
      STATUS="ðŸ”´ error"
      URL="(PM2 process not found)"
    fi
  else
    STATUS="âšª not deployed"
    URL="(run: preview $PROJECT)"
  fi

  # Format output
  printf "â”‚ %-18s â”‚ %-8s â”‚ %-34s â”‚\n" "$PROJECT" "$STATUS" "$URL"
done

echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

# Cleanup temp file
rm -f "$PM2_JSON_FILE"

echo ""
echo "ðŸ”— Commands:"
echo "   new-project [name]    - Create new project"
echo "   preview [name]        - Check preview status"
echo "   pm2 logs [name]       - View logs"
echo "   pm2 restart [name]    - Restart project"
echo ""
