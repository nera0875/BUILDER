#!/bin/bash

# Fix Chrome DevTools MCP - Connect to existing Chrome instance
# Solution from: https://github.com/openai/codex/issues/5166

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${YELLOW}Chrome DevTools MCP Fix - Connect to existing Chrome${NC}"
echo ""

# Step 1: Check if Xvfb is running
echo -e "${BLUE}Checking Xvfb status...${NC}"
if ! pgrep -f "Xvfb :99" > /dev/null; then
    echo -e "${RED}✗ Xvfb not running on :99${NC}"
    echo -e "${YELLOW}Starting Xvfb...${NC}"
    Xvfb :99 -screen 0 1920x1080x24 >/dev/null 2>&1 &
    sleep 2
fi
echo -e "${GREEN}✓ Xvfb running on :99${NC}"

# Step 2: Kill existing Chrome if running
echo -e "${BLUE}Cleaning up existing Chrome processes...${NC}"
pkill -f "google-chrome.*remote-debugging" 2>/dev/null || true
sleep 2

# Step 3: Start Chrome with remote debugging (headful mode on virtual display)
echo -e "${BLUE}Starting Chrome with remote debugging...${NC}"
export DISPLAY=:99
nohup google-chrome \
    --remote-debugging-port=9222 \
    --user-data-dir=/tmp/chrome-debug-headful \
    --no-first-run \
    --disable-gpu \
    --no-sandbox \
    --disable-dev-shm-usage \
    about:blank \
    >/tmp/chrome-launch.log 2>&1 &

CHROME_PID=$!
sleep 3

# Step 4: Verify Chrome is accessible
echo -e "${BLUE}Verifying Chrome CDP endpoint...${NC}"
if curl -s http://localhost:9222/json/version > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Chrome DevTools Protocol active on port 9222${NC}"
    BROWSER_VERSION=$(curl -s http://localhost:9222/json/version | grep -o '"Browser":"[^"]*"' | cut -d'"' -f4)
    echo -e "${GREEN}✓ Browser: $BROWSER_VERSION${NC}"
else
    echo -e "${RED}✗ Failed to connect to Chrome CDP${NC}"
    exit 1
fi

# Step 5: Export DISPLAY for MCP
echo -e "${BLUE}Setting environment for MCP...${NC}"
echo "export DISPLAY=:99" >> ~/.bashrc
export DISPLAY=:99

echo ""
echo -e "${GREEN}✅ Chrome DevTools MCP Fix Complete!${NC}"
echo ""
echo "Configuration:"
echo "  • Display: :99 (Virtual)"
echo "  • Chrome CDP: http://localhost:9222"
echo "  • User Data: /tmp/chrome-debug-headful"
echo "  • Chrome PID: $CHROME_PID"
echo ""
echo -e "${YELLOW}Important:${NC} Chrome is running on virtual display :99"
echo "To view it, use NoVNC at: http://89.116.27.88:6081/vnc.html"
echo ""
echo -e "${GREEN}MCP Chrome DevTools should now work without X server errors!${NC}"