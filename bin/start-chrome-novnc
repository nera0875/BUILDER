#!/bin/bash

# Chrome noVNC Server - Complete VNC solution with web interface
# Provides Chrome with remote debugging + noVNC web interface

set -e

# Configuration
DISPLAY_NUM=99
VNC_PORT=5900
NOVNC_PORT=6081
CDP_PORT=9222
RESOLUTION="1920x1080x24"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Kill existing processes
echo -e "${YELLOW}Stopping existing processes...${NC}"
pkill -f "Xvfb :${DISPLAY_NUM}" 2>/dev/null || true
pkill -f "x11vnc.*:${DISPLAY_NUM}" 2>/dev/null || true
pkill -f "google-chrome.*remote-debugging" 2>/dev/null || true
pkill -f "websockify.*${NOVNC_PORT}" 2>/dev/null || true
pkill fluxbox 2>/dev/null || true
sleep 2

# Start Xvfb (virtual display)
echo -e "${BLUE}Starting Xvfb on display :${DISPLAY_NUM}...${NC}"
Xvfb :${DISPLAY_NUM} -screen 0 ${RESOLUTION} >/dev/null 2>&1 &
XVFB_PID=$!
sleep 2

# Start Fluxbox window manager
echo -e "${BLUE}Starting Fluxbox window manager...${NC}"
DISPLAY=:${DISPLAY_NUM} fluxbox >/dev/null 2>&1 &
FLUXBOX_PID=$!
sleep 1

# Start Chrome with remote debugging
echo -e "${BLUE}Starting Chrome with remote debugging on port ${CDP_PORT}...${NC}"
DISPLAY=:${DISPLAY_NUM} google-chrome \
  --remote-debugging-port=${CDP_PORT} \
  --remote-debugging-address=0.0.0.0 \
  --no-sandbox \
  --disable-gpu \
  --disable-dev-shm-usage \
  --disable-web-security \
  --user-data-dir=/tmp/chrome-mcp-profile \
  --window-size=1920,1080 \
  --force-device-scale-factor=1 \
  --start-maximized \
  about:blank \
  >/dev/null 2>&1 &
CHROME_PID=$!
sleep 3

# Start x11vnc (VNC server WITHOUT password)
echo -e "${BLUE}Starting VNC server...${NC}"
x11vnc -display :${DISPLAY_NUM} \
  -forever \
  -shared \
  -nopw \
  -xkb \
  -rfbport ${VNC_PORT} \
  >/dev/null 2>&1 &
VNC_PID=$!
sleep 2

# Start noVNC web server using websockify
echo -e "${BLUE}Starting noVNC web interface on port ${NOVNC_PORT}...${NC}"
# Use websockify directly with noVNC web files
websockify --web=/opt/noVNC ${NOVNC_PORT} localhost:${VNC_PORT} >/dev/null 2>&1 &
NOVNC_PID=$!

echo -e "${GREEN}‚úì Chrome noVNC server started successfully!${NC}"
echo ""
echo "Access points:"
echo "  üì∫ VNC Web Interface: http://89.116.27.88:${NOVNC_PORT}/vnc.html?host=89.116.27.88&port=${NOVNC_PORT}"
echo "  üîß Chrome DevTools: http://localhost:${CDP_PORT}"
echo "  üåê Dashboard DevTools: http://89.116.27.88:9000/dashboard ‚Üí DevTools tab"
echo ""
echo "MCP Configuration:"
echo "  Chrome DevTools MCP will connect to: localhost:${CDP_PORT}"
echo ""
echo "Process PIDs:"
echo "  Xvfb: $XVFB_PID"
echo "  Fluxbox: $FLUXBOX_PID"
echo "  Chrome: $CHROME_PID"
echo "  x11vnc: $VNC_PID"
echo "  noVNC: $NOVNC_PID"
echo ""
echo "To stop all: pkill -f 'Xvfb :${DISPLAY_NUM}' && pkill -f google-chrome && pkill fluxbox && pkill -f websockify"