#!/bin/bash

# Chrome VNC Server - Direct VPS Chrome with Remote Debugging
# Displays Chrome via VNC for visual debugging while MCP controls it

set -e

# Configuration
DISPLAY_NUM=99
VNC_PORT=6081
CDP_PORT=9222
RESOLUTION="1920x1080x24"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Kill existing processes
echo -e "${YELLOW}Stopping existing processes...${NC}"
pkill -f "Xvfb :${DISPLAY_NUM}" 2>/dev/null || true
pkill -f "x11vnc.*:${DISPLAY_NUM}" 2>/dev/null || true
pkill -f "google-chrome.*remote-debugging" 2>/dev/null || true
sleep 2

# Start Xvfb (virtual display)
echo -e "${BLUE}Starting Xvfb on display :${DISPLAY_NUM}...${NC}"
Xvfb :${DISPLAY_NUM} -screen 0 ${RESOLUTION} >/dev/null 2>&1 &
XVFB_PID=$!
sleep 2

# Start Chrome with remote debugging
echo -e "${BLUE}Starting Chrome with remote debugging on port ${CDP_PORT}...${NC}"
DISPLAY=:${DISPLAY_NUM} google-chrome \
  --remote-debugging-port=${CDP_PORT} \
  --remote-debugging-address=0.0.0.0 \
  --no-sandbox \
  --disable-gpu \
  --disable-dev-shm-usage \
  --disable-web-security \
  --user-data-dir=/tmp/chrome-devtools-profile \
  --window-size=1920,1080 \
  --start-maximized \
  >/dev/null 2>&1 &
CHROME_PID=$!
sleep 3

# Start x11vnc (VNC server)
echo -e "${BLUE}Starting VNC server on port ${VNC_PORT}...${NC}"
x11vnc -display :${DISPLAY_NUM} \
  -forever \
  -shared \
  -nopw \
  -xkb \
  -bg \
  -rfbport ${VNC_PORT} \
  >/dev/null 2>&1

echo -e "${GREEN}âœ“ Chrome VNC server started!${NC}"
echo ""
echo "Access points:"
echo "  VNC: http://localhost:${VNC_PORT}/"
echo "  Chrome DevTools: http://localhost:${CDP_PORT}/"
echo ""
echo "MCP can connect to: http://localhost:${CDP_PORT}"
echo "Dashboard VNC iframe: http://localhost:${VNC_PORT}"
echo ""
echo "PIDs:"
echo "  Xvfb: $XVFB_PID"
echo "  Chrome: $CHROME_PID"
echo ""
echo "To stop: pkill -f 'Xvfb :${DISPLAY_NUM}' && pkill -f google-chrome"